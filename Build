@echo off
chcp 65001 >nul
setlocal enabledelayedexpansion

echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
echo â•‘        Dijital IRS - Build Script     â•‘
echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.

:: Zaman damgasÄ±
for /f "tokens=2 delims==" %%a in ('wmic OS Get localdatetime /value') do set "dt=%%a"
set "YY=%dt:~2,2%" & set "YYYY=%dt:~0,4%" & set "MM=%dt:~4,2%" & set "DD=%dt:~6,2%"
set "HH=%dt:~8,2%" & set "Min=%dt:~10,2%" & set "Sec=%dt:~12,2%"
set "timestamp=%YYYY%-%MM%-%DD%_%HH%-%Min%-%Sec%"

echo ðŸ“… Build ZamanÄ±: %YYYY%-%MM%-%DD% %HH%:%Min%:%Sec%
echo.

:: Build tipi seÃ§imi
echo Build tipi seÃ§in:
echo [1] Console (hata ayÄ±klama iÃ§in)
echo [2] Windowed (normal kullanÄ±m)
echo [3] Debug (detaylÄ± log)
echo.
set /p buildtype="SeÃ§iminiz (1-3): "

if "%buildtype%"=="1" (
    set "windowtype=--console"
    set "buildname=main_window_console.exe"
    echo âœ“ Console build seÃ§ildi
) else if "%buildtype%"=="2" (
    set "windowtype=--windowed"
    set "buildname=main_window.exe"
    echo âœ“ Windowed build seÃ§ildi
) else if "%buildtype%"=="3" (
    set "windowtype=--console --debug=all"
    set "buildname=main_window_debug.exe"
    echo âœ“ Debug build seÃ§ildi
) else (
    echo âŒ GeÃ§ersiz seÃ§im, varsayÄ±lan console build kullanÄ±lÄ±yor
    set "windowtype=--console"
    set "buildname=main_window.exe"
)

echo.
echo ðŸ§¹ [1/5] Temizlik yapÄ±lÄ±yor...
if exist "dist" rmdir /s /q "dist"
if exist "build" rmdir /s /q "build"
if exist "*.spec" del /q "*.spec"
echo    âœ“ Eski dosyalar temizlendi

echo.
echo ðŸ”§ [2/5] BaÄŸÄ±mlÄ±lÄ±klar kontrol ediliyor...
python -c "import customtkinter, pandas, docx, openpyxl; print('âœ“ Ana modÃ¼ller mevcut')" 2>nul
if %ERRORLEVEL% NEQ 0 (
    echo    âŒ Eksik modÃ¼l tespit edildi!
    echo    pip install customtkinter pandas python-docx openpyxl komutunu Ã§alÄ±ÅŸtÄ±rÄ±n
    pause
    exit /b 1
)

echo.
echo ðŸ—ï¸ [3/5] PyInstaller Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...
echo    Parametre: %windowtype%

pyinstaller --onefile %windowtype% --icon=caliper.ico ^
--name=%buildname% ^
--add-data "src;src" ^
--collect-all=tkinter ^
--collect-all=_tkinter ^
--collect-all=docx ^
--collect-all=customtkinter ^
--collect-all=pandas ^
--collect-all=openpyxl ^
--hidden-import=tkinter ^
--hidden-import=tkinter.filedialog ^
--hidden-import=tkinter.messagebox ^
--hidden-import=tkinter.font ^
--hidden-import=tkinter.ttk ^
--hidden-import=_tkinter ^
--hidden-import=webbrowser ^
--hidden-import=docx ^
--hidden-import=services.word_reader ^
--hidden-import=services.data_processor ^
--hidden-import=services.word_save_as ^
--hidden-import=services.project_manager ^
--hidden-import=services.lot_detail_manager ^
--hidden-import=services.auto_save_recovery ^
--hidden-import=ui.components.karakter_view ^
--hidden-import=ui.components.navigation_panel ^
--hidden-import=ui.components.document_viewer ^
--hidden-import=ui.components.stats_panel ^
main_window.py

echo.
if %ERRORLEVEL% EQU 0 (
    echo âœ… [4/5] Build baÅŸarÄ±lÄ±!
    
    if exist "dist\%buildname%" (
        echo.
        echo ðŸ“Š [5/5] Dosya bilgileri:
        echo    ðŸ“ Konum: dist\%buildname%
        for %%A in ("dist\%buildname%") do echo    ðŸ“ Boyut: %%~zA bytes
        echo    ðŸ•’ Zaman: %timestamp%
        
        :: Backup oluÅŸtur
        if not exist "backup" mkdir "backup"
        copy "dist\%buildname%" "backup\%buildname%_%timestamp%.exe" >nul
        echo    ðŸ’¾ Backup: backup\%buildname%_%timestamp%.exe
        
        echo.
        echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        echo â•‘            BUILD TAMAMLANDI âœ…          â•‘
        echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        echo.
        set /p opendir="ðŸ“ Dist klasÃ¶rÃ¼nÃ¼ aÃ§mak ister misiniz? (y/n): "
        if /i "!opendir!"=="y" start explorer "dist"
        
        set /p testrun="ðŸš€ ProgramÄ± test etmek ister misiniz? (y/n): "
        if /i "!testrun!"=="y" (
            echo.
            echo ðŸ§ª Test baÅŸlatÄ±lÄ±yor...
            start "" "dist\%buildname%"
        )
        
    ) else (
        echo âŒ Exe dosyasÄ± oluÅŸturulamadÄ±!
    )
) else (
    echo âŒ [HATA] Build baÅŸarÄ±sÄ±z! Hata kodu: %ERRORLEVEL%
)

echo.
echo ðŸ“ Log dosyasÄ±: build_%timestamp%.log oluÅŸturuldu
echo %timestamp% - Build Type: %buildtype% - Result: %ERRORLEVEL% >> build_log.txt

echo.
pause
