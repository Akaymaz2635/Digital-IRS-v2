# src/ui/components/document_viewer.py
"""
Word dok√ºmanƒ± g√∂r√ºnt√ºleyici component'i - WebView ile HTML rendering
"""
import customtkinter as ctk
import os
import tempfile
import webbrowser
from pathlib import Path
from tkinter import messagebox

# Word to HTML conversion i√ßin
try:
    from docx import Document
    import mammoth
    MAMMOTH_AVAILABLE = True
except ImportError:
    print("mammoth k√ºt√ºphanesi bulunamadƒ±. pip install python-mammoth ile y√ºkleyin")
    MAMMOTH_AVAILABLE = False

# WebView i√ßin
try:
    import tkinterweb
    WEBVIEW_AVAILABLE = True
except ImportError:
    print("tkinterweb bulunamadƒ±. pip install tkinterweb ile y√ºkleyin")
    WEBVIEW_AVAILABLE = False


class DocumentViewer(ctk.CTkFrame):
    """Word dok√ºmanƒ±nƒ± g√∂r√ºnt√ºlemek i√ßin panel - WebView ile"""
    
    def __init__(self, parent):
        super().__init__(parent)
        
        self.current_html_file = None
        self.current_html_content = None
        self.current_zoom = 1.0
        
        self.setup_ui()
    
    def setup_ui(self):
        """Dok√ºman g√∂r√ºnt√ºleyici UI olu≈üturur"""
        # Ba≈ülƒ±k
        self._create_title()
        
        # Kontrol butonlarƒ±
        self._create_control_buttons()
        
        # Ana g√∂r√ºnt√ºleyici
        self._create_viewer()
    
    def _create_title(self):
        """Ba≈ülƒ±k b√∂l√ºm√ºn√º olu≈üturur"""
        title_label = ctk.CTkLabel(
            self,
            text="Word Dok√ºmanƒ±",
            font=ctk.CTkFont(size=16, weight="bold")
        )
        title_label.pack(pady=(10, 5))
    
    def _create_control_buttons(self):
        """Kontrol butonlarƒ±nƒ± olu≈üturur"""
        button_frame = ctk.CTkFrame(self, fg_color="transparent")
        button_frame.pack(pady=5)
        
        # Dok√ºman y√ºkleme butonu
        self.load_button = ctk.CTkButton(
            button_frame,
            text="Dok√ºmanƒ± HTML'de A√ß",
            command=self.open_in_browser,
            state="disabled",
            width=150
        )
        self.load_button.pack(side="left", padx=5)
        
        # Yenile butonu
        self.refresh_button = ctk.CTkButton(
            button_frame,
            text="Yenile",
            command=self.refresh_webview,
            state="disabled",
            width=80
        )
        self.refresh_button.pack(side="left", padx=5)
        
        # Zoom sƒ±fƒ±rla butonu
        self.reset_zoom_button = ctk.CTkButton(
            button_frame,
            text="Zoom Reset",
            command=self.reset_zoom,
            state="disabled",
            width=100
        )
        self.reset_zoom_button.pack(side="left", padx=5)
    
    def _create_viewer(self):
        """Ana g√∂r√ºnt√ºleyici alanƒ±nƒ± olu≈üturur"""
        if WEBVIEW_AVAILABLE:
            self._create_webview()
        else:
            self._create_fallback_textbox()
    
    def _create_webview(self):
        """WebView olu≈üturur - scrollbar problemi d√ºzeltildi"""
        # WebView frame
        self.web_frame = ctk.CTkFrame(self)
        self.web_frame.pack(fill="both", expand=True, padx=10, pady=10)
        
        # ===== SCROLLBAR SORUNU D√úZELTMESƒ∞ =====
        # tkinterweb.HtmlFrame i√ßin doƒüru parametreler
        try:
            self.webview = tkinterweb.HtmlFrame(
                self.web_frame,
                # Scrollbar ayarlarƒ± - "auto" yerine "both" kullan
                horizontal_scrollbar="both",  # Yatay scrollbar'ƒ± zorla
                vertical_scrollbar="both",    # Dikey scrollbar'ƒ± zorla
                # Boyut ayarlarƒ± - √ßok k√º√ß√ºk deƒüerler scrollbar sorununa neden olur
                width=800,   # Minimum geni≈ülik artƒ±rƒ±ldƒ±
                height=600   # Minimum y√ºkseklik artƒ±rƒ±ldƒ±
            )
        except Exception as e:
            print(f"HtmlFrame olu≈üturma hatasƒ±: {e}")
            # Fallback - daha basit parametreler
            self.webview = tkinterweb.HtmlFrame(
                self.web_frame,
                horizontal_scrollbar=True,
                vertical_scrollbar=True
            )
        # =======================================
        
        self.webview.pack(fill="both", expand=True)
        
        # Event bindings
        self.webview.bind("<Control-MouseWheel>", self.on_zoom)
        self.webview.focus_set()
        
        # Ba≈ülangƒ±√ß HTML
        self._load_initial_html()
    
    def _create_fallback_textbox(self):
        """WebView yoksa fallback textbox olu≈üturur"""
        self.text_area = ctk.CTkTextbox(
            self,
            wrap="word",
            font=ctk.CTkFont(size=11)
        )
        self.text_area.pack(fill="both", expand=True, padx=10, pady=10)
        self.text_area.insert("1.0", "tkinterweb k√ºt√ºphanesi bulunamadƒ±.\nHTML g√∂r√ºnt√ºleme i√ßin: pip install tkinterweb")
        self.text_area.configure(state="disabled")
    
    def _load_initial_html(self):
        """Ba≈ülangƒ±√ß HTML'ini y√ºkler"""
        if not WEBVIEW_AVAILABLE:
            return
            
        initial_html = """
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
                body { 
                    font-family: Arial; 
                    padding: 20px; 
                    background-color: #2b2b2b; 
                    color: white; 
                    margin: 0;
                    /* SCROLLBAR D√úZELTMESƒ∞: minimum geni≈ülik ayarla */
                    min-width: 1200px;
                    overflow-x: auto;
                }
                .content {
                    width: 100%;
                    min-width: 1000px;
                }
            </style>
        </head>
        <body>
            <div class="content">
                <h3>Word Dok√ºmanƒ± G√∂r√ºnt√ºleyici</h3>
                <p>Word dosyasƒ± y√ºklendiƒüinde dok√ºman i√ßeriƒüi burada g√∂r√ºnecek.</p>
                <p><strong>√ñzellikler:</strong></p>
                <ul>
                    <li>Tam HTML formatting</li>
                    <li>Tablo yapƒ±sƒ± korunur</li>
                    <li>Scrollable i√ßerik</li>
                    <li>Ctrl + Mouse Wheel ile zoom</li>
                </ul>
                <p>Test i√ßin yatay scroll: Bu √ßok uzun bir satƒ±r. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris.</p>
            </div>
        </body>
        </html>
        """
        self.webview.load_html(initial_html)
    
    def load_document(self, file_path: str):
        """Word dok√ºmanƒ±nƒ± y√ºkler ve g√∂r√ºnt√ºler"""
        if not MAMMOTH_AVAILABLE:
            self._show_error("Mammoth k√ºt√ºphanesi bulunamadƒ±!")
            return
            
        try:
            print(f"Dok√ºman WebView'da y√ºkleniyor: {file_path}")
            
            if WEBVIEW_AVAILABLE:
                self._show_loading_message()
            
            # Word dok√ºmanƒ±nƒ± i≈üle
            html_content = self._convert_word_to_html(file_path)
            
            if html_content:
                # Styled HTML olu≈ütur - scrollbar d√ºzeltmeli
                styled_html = self._create_styled_html_fixed(html_content, file_path)
                self.current_html_content = styled_html
                
                if WEBVIEW_AVAILABLE:
                    self.webview.load_html(styled_html)
                    self._enable_buttons()
                
                # HTML dosyasƒ± olu≈ütur
                self._create_html_file(styled_html, file_path)
                
                print("‚úì Dok√ºman WebView'da ba≈üarƒ±yla y√ºklendi")
            else:
                self._show_fallback_content(file_path)
                
        except Exception as e:
            error_msg = f"Dok√ºman y√ºkleme hatasƒ±: {str(e)}"
            print(error_msg)
            self._show_error(error_msg)
    
    def _show_loading_message(self):
        """Y√ºkleniyor mesajƒ±nƒ± g√∂sterir"""
        if WEBVIEW_AVAILABLE:
            loading_html = """
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="utf-8">
                <style>
                    body { 
                        font-family: Arial; 
                        padding: 20px; 
                        background-color: #2b2b2b; 
                        color: white; 
                        min-width: 800px;
                    }
                </style>
            </head>
            <body>
                <h3>Y√ºkleniyor...</h3>
                <p>Word dok√ºmanƒ± i≈üleniyor, l√ºtfen bekleyin...</p>
            </body>
            </html>
            """
            self.webview.load_html(loading_html)
    
    def _convert_word_to_html(self, file_path: str) -> str:
        """Word dosyasƒ±nƒ± HTML'e d√∂n√º≈üt√ºr√ºr"""
        try:
            with open(file_path, "rb") as docx_file:
                result = mammoth.convert_to_html(docx_file)
                
                if hasattr(result, 'value'):
                    return result.value
                elif hasattr(result, 'html'):
                    return result.html
                else:
                    raise Exception("HTML content bulunamadƒ±")
                    
        except Exception as e:
            print(f"HTML d√∂n√º≈üt√ºrme hatasƒ±: {e}")
            return None
    
    def _create_styled_html_fixed(self, html_content: str, file_path: str) -> str:
        """HTML i√ßeriƒüini scrollbar d√ºzeltmeli stillendirme ile d√ºzenler"""
        file_name = Path(file_path).stem
        
        styled_html = f"""
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>Word Dok√ºmanƒ± - {file_name}</title>
            <style>
                /* SCROLLBAR D√úZELTMESƒ∞ ƒ∞√áƒ∞N CSS */
                html, body {{ 
                    font-family: 'Segoe UI', Arial, sans-serif; 
                    margin: 0; 
                    padding: 0;
                    line-height: 1.6;
                    background-color: #2b2b2b;
                    color: #ffffff;
                    /* Yatay scroll i√ßin minimum geni≈ülik */
                    min-width: 1200px;
                    overflow-x: auto;
                    overflow-y: auto;
                }}
                
                .document-container {{
                    padding: 20px;
                    width: 100%;
                    min-width: 1000px; /* Tablolar i√ßin minimum geni≈ülik */
                    box-sizing: border-box;
                }}
                
                h1, h2, h3 {{
                    color: #4fc3f7;
                    border-bottom: 2px solid #4fc3f7;
                    padding-bottom: 5px;
                }}
                
                table {{ 
                    border-collapse: collapse; 
                    width: 100%; 
                    /* SCROLLBAR D√úZELTMESƒ∞: Tablolar i√ßin minimum geni≈ülik */
                    min-width: 800px;
                    margin: 15px 0;
                    background-color: #3b3b3b;
                    border-radius: 5px;
                    overflow: visible; /* Overflow'u g√∂ster */
                    table-layout: auto; /* Otomatik tablo layout */
                }}
                
                th, td {{ 
                    border: 1px solid #555; 
                    padding: 12px 8px; 
                    text-align: left;
                    /* H√ºcre i√ßeriƒüinin wrap olmamasƒ± i√ßin */
                    white-space: nowrap;
                    overflow: visible;
                }}
                
                th {{ 
                    background-color: #4fc3f7; 
                    font-weight: bold;
                    color: #000;
                }}
                
                tr:nth-child(even) {{
                    background-color: #404040;
                }}
                
                tr:hover {{
                    background-color: #505050;
                }}
                
                p {{
                    margin: 10px 0;
                }}
                
                .header {{
                    text-align: center;
                    margin-bottom: 30px;
                    padding: 20px;
                    background-color: #404040;
                    border-radius: 10px;
                }}
                
                /* Resimler i√ßin */
                img {{
                    max-width: none; /* Resimlerin kƒ±rpƒ±lmamasƒ± i√ßin */
                    height: auto;
                }}
            </style>
        </head>
        <body>
            <div class="document-container">
                <div class="header">
                    <h1>üìã Word Dok√ºmanƒ±</h1>
                    <h2>{file_name}</h2>
                </div>
                {html_content}
            </div>
        </body>
        </html>
        """
        
        return styled_html
    
    def _show_fallback_content(self, file_path: str):
        """Fallback i√ßerik g√∂sterir"""
        if not WEBVIEW_AVAILABLE:
            return
            
        try:
            # Basit text extraction deneme
            doc = Document(file_path)
            
            # Text content topla
            text_content = ""
            for para in doc.paragraphs:
                if para.text.strip():
                    text_content += f"<p>{para.text}</p>"
            
            # Tablolarƒ± HTML olarak ekle
            table_html = ""
            for i, table in enumerate(doc.tables):
                table_html += f"<h3>Tablo {i+1}</h3><table style='min-width: 600px;'>"
                for row in table.rows:
                    table_html += "<tr>"
                    for cell in row.cells:
                        table_html += f"<td style='white-space: nowrap;'>{cell.text}</td>"
                    table_html += "</tr>"
                table_html += "</table>"
            
            fallback_html = f"""
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="utf-8">
                <style>
                    body {{ 
                        font-family: Arial; 
                        padding: 20px; 
                        background-color: #2b2b2b; 
                        color: white; 
                        min-width: 1000px;
                        overflow-x: auto;
                    }}
                    table {{ min-width: 600px; }}
                    td {{ white-space: nowrap; }}
                </style>
            </head>
            <body>
                <h2>Word Dok√ºmanƒ± (Text Modu)</h2>
                <p><em>HTML d√∂n√º≈üt√ºrme ba≈üarƒ±sƒ±z, basit text modu kullanƒ±lƒ±yor.</em></p>
                {text_content}
                {table_html}
            </body>
            </html>
            """
            
            self.webview.load_html(fallback_html)
            print("Fallback text modu y√ºklendi")
            
        except Exception as e:
            print(f"Fallback content hatasƒ±: {e}")
            self._show_error("Dok√ºman y√ºklenemedi")
    
    def _show_error(self, error_message: str):
        """Hata mesajƒ±nƒ± g√∂sterir"""
        if WEBVIEW_AVAILABLE:
            error_html = f"""
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="utf-8">
                <style>
                    body {{ 
                        font-family: Arial; 
                        padding: 20px; 
                        background-color: #2b2b2b; 
                        color: #ff6b6b; 
                        min-width: 800px;
                    }}
                </style>
            </head>
            <body>
                <h3>Hata!</h3>
                <p>{error_message}</p>
                <p>L√ºtfen dosyayƒ± kontrol edin ve tekrar deneyin.</p>
            </body>
            </html>
            """
            self.webview.load_html(error_html)
    
    def _enable_buttons(self):
        """Butonlarƒ± aktif eder"""
        self.load_button.configure(state="normal")
        self.refresh_button.configure(state="normal")
        if WEBVIEW_AVAILABLE:
            self.reset_zoom_button.configure(state="normal")
    
    def _create_html_file(self, html_content: str, original_file: str):
        """HTML dosyasƒ± olu≈üturur"""
        try:
            temp_dir = tempfile.gettempdir()
            file_name = Path(original_file).stem
            html_file = os.path.join(temp_dir, f"{file_name}_preview.html")
            
            with open(html_file, 'w', encoding='utf-8') as f:
                f.write(html_content)
            
            self.current_html_file = html_file
            print(f"‚úì HTML dosyasƒ± olu≈üturuldu: {html_file}")
            
        except Exception as e:
            print(f"HTML dosyasƒ± olu≈üturma hatasƒ±: {e}")
    
    def on_zoom(self, event):
        """Ctrl + Mouse Wheel ile zoom"""
        if not WEBVIEW_AVAILABLE:
            return
        
        try:
            delta = event.delta
            zoom_factor = 0.1
            
            if delta > 0:  # Zoom in
                self.current_zoom += zoom_factor
            else:  # Zoom out
                self.current_zoom -= zoom_factor
            
            # Zoom sƒ±nƒ±rlarƒ±
            self.current_zoom = max(0.5, min(self.current_zoom, 3.0))
            
            # Zoom uygula
            self._apply_zoom()
            
        except Exception as e:
            print(f"Zoom hatasƒ±: {e}")
    
    def _apply_zoom(self):
        """Zoom seviyesini uygular"""
        if not WEBVIEW_AVAILABLE or not self.current_html_content:
            return
            
        try:
            # JavaScript ile zoom deneme
            zoom_script = f'document.body.style.zoom = "{self.current_zoom}";'
            self.webview.run_script(zoom_script)
            print(f"Zoom seviyesi: %{self.current_zoom*100:.0f}")
            
        except:
            # Fallback: HTML'i yeniden y√ºkle
            self._apply_zoom_to_html()
    
    def _apply_zoom_to_html(self):
        """HTML'e zoom CSS'i ekleyerek yeniden y√ºkle"""
        if not self.current_html_content or not WEBVIEW_AVAILABLE:
            return
            
        zoom_style = f"""
        <style>
        .document-container {{ transform: scale({self.current_zoom}); transform-origin: top left; width: {100/self.current_zoom}%; }}
        </style>
        """
        
        # HTML'e zoom style'ƒ± ekle
        zoomed_html = self.current_html_content.replace("</head>", f"{zoom_style}</head>")
        self.webview.load_html(zoomed_html)
    
    def reset_zoom(self):
        """Zoom'u sƒ±fƒ±rla"""
        if WEBVIEW_AVAILABLE:
            self.current_zoom = 1.0
            self._apply_zoom()
            print("Zoom %100'e sƒ±fƒ±rlandƒ±")
    
    def refresh_webview(self):
        """WebView'ƒ± yenile"""
        if WEBVIEW_AVAILABLE and self.current_html_content:
            self.webview.load_html(self.current_html_content)
            print("WebView yenilendi")
    
    def open_in_browser(self):
        """HTML dosyasƒ±nƒ± tarayƒ±cƒ±da a√ß"""
        if self.current_html_file and os.path.exists(self.current_html_file):
            try:
                webbrowser.open(f'file://{self.current_html_file}')
                print(f"HTML dosyasƒ± tarayƒ±cƒ±da a√ßƒ±ldƒ±: {self.current_html_file}")
            except Exception as e:
                messagebox.showerror("Hata", f"Tarayƒ±cƒ±da a√ßƒ±lamadƒ±: {str(e)}")
        else:
            messagebox.showwarning("Uyarƒ±", "√ñnce bir dok√ºman y√ºkleyin!")
    
    def get_zoom_level(self) -> float:
        """Mevcut zoom seviyesini d√∂ner"""
        return self.current_zoom
    
    def set_zoom_level(self, zoom: float):
        """Zoom seviyesini ayarlar"""
        self.current_zoom = max(0.5, min(zoom, 3.0))
        self._apply_zoom()
    
    def is_document_loaded(self) -> bool:
        """Dok√ºman y√ºklenip y√ºklenmediƒüini kontrol eder"""
        return self.current_html_content is not None
